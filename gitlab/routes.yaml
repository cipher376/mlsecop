apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: gitlab-webservice-route
  namespace: ml-build
spec:
  parentRefs:
  - name: cilium-ingress-gateway
    sectionName: https # Using the general listener for simplicity
    namespace: ml-infrastructure
  hostnames:
  - "gitlab.mlsecops.local"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: gitlab-webservice-default
      port: 8181 # Internal GitLab Rails port
    filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: "https"
              - name: X-Forwarded-Ssl
                value: "on"
              - name: X-Forwarded-Port
                value: "443"

---
# GitLab Registry Route
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: gitlab-registry
  namespace: ml-build
spec:
  parentRefs:
    - name: cilium-ingress-gateway
      namespace: ml-infrastructure
  
  hostnames:
    - "registry.mlsecops.local"
    - "registry.gitlab.mlsecops.local"
  
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: gitlab-registry
          port: 5000
      
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: "https"

---
# GitLab Pages (if enabled)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: gitlab-pages
  namespace: ml-build
spec:
  parentRefs:
    - name: cilium-ingress-gateway
      namespace: ml-infrastructure
  
  hostnames:
    - "*.pages.mlsecops.local"
  
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: gitlab-pages
          port: 8090