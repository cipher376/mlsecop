global:
  hosts:
    domain: mlsecops.local
    https: true # Note: If false, GitLab will use http:// internal links

  appConfig:
    # This tells GitLab to trust the headers coming from Cilium
    external_url: https://gitlab.mlsecops.local

  minio:
    enabled: false
    ingress:
      enabled: false

  ingress:
    enabled: false # We will manage ingress separately with HTTPRoute

  # ── EXTERNAL DATABASE ──────────────────────────────────────────────
  psql:
    # 'install: false' does NOT go here; it goes at the root level
    host: gitlab-db-postgresql.ml-build.svc.cluster.local
    port: 5432
    username: gitlab      # Ensure this matches the 'ALTER ROLE' name
    database: gitlabhq_production
    password:
      secret: gitlab-db-postgresql-secret
      key: password

  # ── EXTERNAL REDIS ─────────────────────────────────────────────────
  redis:
    host: gitlab-redis-master.ml-build.svc.cluster.local
    auth:
      enabled: true
      secret: gitlab-redis-secret
      key: redis-password

  # ── MONITORING ─────────────────────────────────────────────────────
  monitoring:
    prometheus:
      install: false
      host: prometheus-operated.ml-monitoring.svc.cluster.local
      port: 9090

  # ── CONSOLIDATED OBJECT STORAGE (SeaweedFS) ────────────────────────
  appConfig:
    object_store:
      enabled: true
      connection:
        secret: gitlab-seaweedfs-db-secret
        key: connection
    
    # These settings tell GitLab which buckets to use in SeaweedFS
    lfs:
      enabled: true
      bucket: gitlab-lfs
    artifacts:
      enabled: true
      bucket: gitlab-artifacts
    uploads:
      enabled: true
      bucket: gitlab-uploads
    packages:
      enabled: true
      bucket: gitlab-packages
    externalDiffs:
      enabled: true
      bucket: gitlab-external-diffs
    terraformState:
      enabled: true
      bucket: gitlab-terraform-state
    dependencyProxy:
      enabled: true
      bucket: gitlab-dependency-proxy

# ── TOP-LEVEL SUBCHART DISABLES ───────────────────────────────────────
# This is where 'install: false' belongs
postgresql:
  install: false

redis:
  install: false

minio:
  install: false

prometheus:
  install: false

gitlab-runner:
  install: false

nginx-ingress:
  enabled: false

pages:
  enabled: true
  # This is usually a separate domain from your main GitLab instance
  host: pages.mlsecops.local

certmanager-issuer:
  email: dummynerd@mlsecops.local  # Replace with your actual email

installCertmanager: false # Move it to the root level, not under a 'certmanager' block

# ── COMPONENT SPECIFIC OVERRIDES ──────────────────────────────────────
gitlab:
  name: gitlab.mlsecops.local
  https: true
  webservice:
    replicaCount: 2
    ingress:
      enabled: false # We will manage ingress separately with HTTPRoute
    
    extraEnv:
      GITLAB_HTTPS: "true"
      GITLAB_HOST: "gitlab.mlsecops.local"
      GITLAB_PORT: "443"
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.mlsecops.local'
        nginx['listen_https'] = false
        nginx['listen_port'] = 8080
        
        # Trust proxy headers
        #nginx['real_ip_trusted_addresses'] = ['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16']
        #nginx['real_ip_header'] = 'X-Real-IP'
        #nginx['real_ip_recursive'] = 'on'
        
        # HTTPS settings
        gitlab_rails['gitlab_https'] = true
        gitlab_workhorse['listen_network'] = "tcp"
        gitlab_workhorse['listen_addr'] = "0.0.0.0:8181"
    resources:
      requests:
        ephemeral-storage: "2Gi"
      limits:
        ephemeral-storage: "4Gi"
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 4Gi
  sidekiq:
    replicaCount: 1
    resources:
      requests:
        ephemeral-storage: "2Gi"
      limits:
        ephemeral-storage: "4Gi"
  gitaly:
    persistence:
      size: 50Gi
  migrations: # Help migrations run successfully by giving them more resources
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 1000m
        memory: 4Gi
  
  # CRITICAL: Point the Registry to SeaweedFS as well
  registry:
    enabled: true
    ingress:
      enabled: false
    storage:
      secret: gitlab-seaweedfs-db-secret
      key: connection
  
  gitlab-shell:
    ingress:
      enabled: false

  gitlab-pages:
    enabled: true

registry:
  ingress:
    enabled: false